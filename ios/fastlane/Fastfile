def app_identifiers
  ["io.bluewallet.bluewallet", "io.bluewallet.bluewallet.watch", "io.bluewallet.bluewallet.watch.extension", "io.bluewallet.bluewallet.MarketWidget"]
end

platform :ios do

  before_all do |lane, options|
    UI.message("Setting up for all lanes...")

    # Perform a single cleanup of untracked changes
    sh("git clean -fd")
    sh("git checkout -- .")
  end

  desc "Create a temporary keychain"
  lane :create_temp_keychain do
    UI.message("Creating a temporary keychain...")

    create_keychain(
      name: "temp_keychain",
      password: ENV["KEYCHAIN_PASSWORD"],
      default_keychain: true,
      unlock: true,
      timeout: 3600,
      lock_when_sleeps: true
    )

    UI.message("Temporary keychain created successfully.")
  end

  desc "Setup Provisioning Profiles and Certificates"
  lane :setup_profiles do
    UI.message("Setting up provisioning profiles and certificates from the repo...")

    # Download the provisioning profiles and certificates from the repo
    sh("curl -o ~/provisioning_profiles.tar.gz #{ENV['PROFILES_REPO_URL']}")
    sh("curl -o ~/certificates.tar.gz #{ENV['CERTIFICATES_REPO_URL']}")

    # Extract the provisioning profiles and certificates
    sh("tar -xvzf ~/provisioning_profiles.tar.gz -C ~/Library/MobileDevice/Provisioning\\ Profiles/")
    sh("tar -xvzf ~/certificates.tar.gz -C ~/Library/Keychains/")
  end

  desc "Clear derived data"
  lane :clear_derived_data_lane do
    UI.message("Clearing derived data...")
    clear_derived_data
  end

  desc "Increment build number"
  lane :increment_build_number_lane do
    UI.message("Incrementing build number to current timestamp...")

    increment_build_number(
      xcodeproj: "BlueWallet.xcodeproj",
      build_number: ENV["NEW_BUILD_NUMBER"]
    )

    UI.message("Build number set to: #{ENV['NEW_BUILD_NUMBER']}")
  end

  desc "Install CocoaPods dependencies"
  lane :install_pods do
    UI.message("Installing CocoaPods dependencies...")
    cocoapods
  end

  desc "Build the BlueWallet iOS app"
  lane :build_bluewallet_ios_app do
    build_app(
      scheme: "BlueWallet",
      workspace: "BlueWallet.xcworkspace",
      export_method: "app-store",
      include_bitcode: false,
      configuration: "Release",
      skip_profile_detection: false,
      include_symbols: true,
      export_options: {
        signingStyle: "manual",
        provisioningProfiles: {
          'io.bluewallet.bluewallet' => 'match AppStore io.bluewallet.bluewallet',
          'io.bluewallet.bluewallet.watch' => 'match AppStore io.bluewallet.bluewallet.watch',
          'io.bluewallet.bluewallet.watch.extension' => 'match AppStore io.bluewallet.bluewallet.watch.extension',
          'io.bluewallet.bluewallet.MarketWidget' => 'match AppStore io.bluewallet.bluewallet.MarketWidget',
          'io.bluewallet.bluewallet.watch.Stickers' => 'match AppStore io.bluewallet.bluewallet.Stickers',
        }
      },
      xcargs: "GCC_PREPROCESSOR_DEFINITIONS='$(inherited) VERBOSE_LOGGING=1'",
      output_directory: "./build",
      output_name: "BlueWallet.#{ENV['PROJECT_VERSION']}(#{ENV['NEW_BUILD_NUMBER']}).ipa",
      buildlog_path: "./build_logs"
    )
  end

  desc "Build the Mac Catalyst app"
  lane :build_catalyst_app do
    build_app(
      scheme: "BlueWallet",
      workspace: "BlueWallet.xcworkspace",
      configuration: "Release",
      sdk: "macosx",
      export_method: "app-store",
      include_bitcode: false,
      export_options: {
        signingStyle: "manual",
        provisioningProfiles: {
          'io.bluewallet.bluewallet' => 'match AppStore io.bluewallet.bluewallet catalyst',
          'io.bluewallet.bluewallet.watch' => 'match AppStore io.bluewallet.bluewallet.watch catalyst',
          'io.bluewallet.bluewallet.watch.extension' => 'match AppStore io.bluewallet.bluewallet.watch.extension catalyst',
          'io.bluewallet.bluewallet.MarketWidget' => 'match AppStore io.bluewallet.bluewallet.MarketWidget catalyst'
        }
      },
      output_directory: "./build-catalyst",
      output_name: "BlueWallet.#{ENV['PROJECT_VERSION']}(#{ENV['NEW_BUILD_NUMBER']}).app",
      buildlog_path: "./build_logs"
    )
  end

  desc "Notarize the Mac Catalyst app and create a DMG"
  lane :notarize_and_create_dmg do
    UI.message("Notarizing the Mac Catalyst app...")

    notarize(
      username: ENV['NOTARIZE_USERNAME'],
      team_id: ENV['ITC_TEAM_ID'],
      app_bundle_id: "io.bluewallet.bluewallet",
      app_path: "./build-catalyst/BlueWallet.#{ENV['PROJECT_VERSION']}(#{ENV['NEW_BUILD_NUMBER']}).app",
      primary_bundle_id: "io.bluewallet.bluewallet",
      app_specific_password: ENV['NOTARIZE_PASSWORD']
    )

    UI.message("Creating DMG...")
    sh("hdiutil create -volname BlueWallet -srcfolder ./build-catalyst/BlueWallet.#{ENV['PROJECT_VERSION']}(#{ENV['NEW_BUILD_NUMBER']}).app -ov -format UDZO ./build-catalyst/BlueWallet.#{ENV['PROJECT_VERSION']}(#{ENV['NEW_BUILD_NUMBER']}).dmg")
  end

  desc "Upload iOS app to TestFlight"
  lane :upload_ios_to_testflight do
    UI.message("Uploading iOS App to TestFlight...")
    upload_to_testflight(
      ipa: "./build/BlueWallet.#{ENV['PROJECT_VERSION']}(#{ENV['NEW_BUILD_NUMBER']}).ipa",
      skip_waiting_for_build_processing: true,
      changelog: ENV["LATEST_COMMIT_MESSAGE"]
    )
  end

  desc "Upload Mac Catalyst app to TestFlight"
  lane :upload_catalyst_to_testflight do
    UI.message("Uploading Mac Catalyst app to TestFlight...")
    upload_to_testflight(
      ipa: "./build-catalyst/BlueWallet.#{ENV['PROJECT_VERSION']}(#{ENV['NEW_BUILD_NUMBER']}).app",
      skip_waiting_for_build_processing: true,
      changelog: ENV["LATEST_COMMIT_MESSAGE"]
    )
  end

  desc "Save artifacts for the action summary"
  lane :save_artifacts do
    UI.message("Saving artifacts for the action summary...")
    sh("mkdir -p artifacts && cp ./build-catalyst/BlueWallet.#{ENV['PROJECT_VERSION']}(#{ENV['NEW_BUILD_NUMBER']}).dmg ./artifacts/")
    sh("mkdir -p artifacts && cp ./build/BlueWallet.#{ENV['PROJECT_VERSION']}(#{ENV['NEW_BUILD_NUMBER']}).ipa ./artifacts/")
  end
end
