import assert from 'assert';
import { joinQRs, splitQRs } from '../../blue_modules/bbqr/main';
import { base64ToUint8Array, uint8ArrayToBase64, uint8ArrayToString } from '../../blue_modules/uint8array-extras';
import * as bitcoin from 'bitcoinjs-lib';
import { BlueURDecoder } from '../../blue_modules/ur';

const walletExportParts = [
  'B$2J0700PMRGG2DBNFXCEORAEJBFIQZCFQQCE6DGOARDUIBCII3DQQKGGZCTIIRMEARGCY3DN52W45BCHIQDALBAEJ4HA5LCEI5CAITYOB2WENRWGFGXSTLXIFYVEYTDI5RGMUDUNF2WS2LLOIYUGQ2QGZRTCRTLORYW2WSEOR2GIVLEIFTVSUSBN5UW6V2LMFZFOY2DNZNFANLDO5UTKV2HPAZWS6KRMRLXMN22OM2FKUJUGEZUO5KHOIZUW6KMMNZXMVTTK5BEG4LCPBHDKYL2EIWCAITCNFYDINBCHIQHWITOMFWWKIR2EARHAMTQNNUCELBAEJ4GM4BCHIQCEOJWG4YUGMZQG4RCYIBCMRSXE2LWEI5CAITNF42DI2BPGBUC6MDIEIWCAITYOB2WEIR2EARHQ4DVMI3EGTLQMVBFQZCFJNBTG23YIE4TMTDFPF3EUZ3YKFTFAYTYLB2UU5JZGF3VMY2MNJMUWTLDKNTDCZCNOI4UQRLLJZKXSZCQKR4E2MKTNNWXK5DOLFVEM2LLOIZDOSSVORKVG4KQHFTXCMJSHE4VGUBXMVFXES2GOI4VS2TTOJIEKIRMEARGIZLTMMRDUIBCOBVWQKC3MI3DQYLGGZSTILZUGRUC6MDIF4YGQXLYOB2WENSDJVYGKQSYMRCUWQZTNN4ECOJWJRSXS5SKM54FCZSQ',
  'B$2J0701MJ4FQ5KKOU4TC52WMNGGUWKLJVRVGZRRMRGXEOKIIVVU4VLZMRIFI6CNGFJWW3LVORXFS2SGNFVXEMRXJJKXIVKTOFIDSZ3RGEZDSOKTKA3WKS3SJNDHEOKZNJZXEUCFF46DAOZRHYXSUKJDMV3WYNDDNV2HSIRMEARGM2LSON2CEORAEIYUIRTBOZYGUODYN5UGSZ2YOJMHO2ZRKBYGIRRTOJ3VIZKINM2DSNCMEJ6SYIBCMJUXANBZEI5CA6ZCNZQW2ZJCHIQCE4BSONUC24BSO5YGW2BCFQQCE6DGOARDUIBCGA4TSQSEIVBDSIRMEARGIZLSNF3CEORAEJWS6NBZNAXTA2BPGBUCELBAEJ4HA5LCEI5CAITYOB2WENSDLJTXEOCZIJUGK3STKU4HO52ZKFKHCUZWJBZHGQKLGJ4DQ4LXKF3FCWCMJJ3TKWLEJI3DGQRSLJCVGWCKOZXTG6KIM5REQNCDOFDVEMSOGRXUUVKUNFZFKQ3PM44GS6DVJVSG2NSDKBKUIRDBGZ3W65CUGZXWGU2KIVCDC5JSEIWCAITEMVZWGIR2EARHG2BIO5YGW2BILNRDMODBMY3GKNBPGQ4WQLZQNAXTA2C5PBYHKYRWINNGO4RYLFBGQZLOKNKTQ53XLFIVI4KTGZEHE42BJMZHQODRO5IXMUKYJRFHONKZ',
  'B$2J0702MRFDMM2CGJNEKU2YJJ3G6M3ZJBTWESBUINYUOURSJY2G6SSVKRUXEVKDN5TTQ2LYOVGWI3JWINIFKRCEME3HO33UKQ3G6Y2TJJCUIMLVGIXTYMB3GE7C6KRJFERXANTXGRXDS4BWEIWCAIS7OB2WEIR2EARHS4DVMI3FQUDYHFXUINTSJRFXMS2THE2E43KGKRSUEUCOGM4FIVLUNNYVGTBSOZVTO2DQPB3GIZTZGZDXC3SWGZTXGWLSNE3UU5CZOM2DOVSCOBTFK42ZNY2TEQSXOBVWO6DLJBTWE3LFLJFXG6SMLF2XUZ3SMRHGS4DTIZYHE32HOBJXKIRMEARGM2LSON2CEORAEIZUIN3HINXWS5RVORYDCM3QJNRHQ2BVKJVXIZJZGNAVM2KROBNGGUZXEJ6SYIBCMJUXAOBUEI5CA6ZCNZQW2ZJCHIQCE4BSO5YGW2BCFQQCE6DGOARDUIBCIEZDAOCBGMZUMIRMEARGIZLSNF3CEORAEJWS6OBUNAXTA2BPGBUCELBAEJ4HA5LCEI5CAITYOB2WENSEJVUUWMLEG5RXE2TDMFXDOOKSIQ3FUU2UI54U4Q2LKA4FEUZZGVSWS32CINFWMN2SMV4VURTQN54GSVZSOFGXMTCDLJSE4QZZK5UU2Z3XPFGU2Y2MO5DFI6DJOI2UGNDCJM2WCUTO',
  'B$2J0703LBTWQOLQIFGTCZTKNJ4EGMKIOBCTMSDGEIWCAITEMVZWGIR2EARHO4DLNAUFWYRWHBQWMNTFGQXTQNDIF4YGQLZQNBOXQ4DVMI3EITLJJMYWIN3DOJVGGYLOG44VERBWLJJVIR3ZJZBUWUBYKJJTSNLFNFXUEQ2LMY3VEZLZLJDHA33YNFLTE4KNOZGEGWTEJZBTSV3JJVTXO6KNJVRUY52GKR4GS4RVIM2GESZVMFJG4WDHNA4XAQKNGFTGU2TYIMYUQ4CFGZEGMLZ4GA5TCPRPFIUSG6L2HFTDI5RTPIRCYIBCL5YHKYRCHIQCE6TQOVRDM4ZSIV3EY6DXOZCHAYKIJZLFANLWMZXXEZCUPFUTQY2IGFTFEODVONWUK2T2G5JHGU2RNJTFIVCHKUZHCQJVKZCWGRLZLFMUE6DQLJAXSQTBOJFG6VDSMFBDIVSSJJFVM6RZG5AXKOLKKJHFSZSMIFSWKSCDGVKW4US2MJ5DQWJCFQQCEZTJOJZXIIR2EARGEYZROE4HIYLSOQ3XI5RWMRQTM6LMOFQXKZRSMZSGKMRTOZ3WO4DTMFVXQ6TONNTDOYZCPUWCAITCNFYDIOC7GERDUID3EJXGC3LFEI5CAITQGJZWQLLQGJ3XG2BCFQQCE6DGOARDUIBCGIYEMM2GIIZUMIRMEARGIZLSNF3CEORA',
  'B$2J0704EJWS6NBYNAXTA2BPGBUC6MLIEIWCAITYOB2WEIR2EARHQ4DVMI3EKTSYOU3GUUBTLBTVQOKRIRFXSM3FKNKUI4DVONVUEM2VMFUGO2LGIM2WU5CUPJCTS6TFM42HK2CNNJWVG53FOA3HEWSCNNUFI42UM5FDI4RWGRMUK4DEJNSDGMJRLFBEMULPOM3UQNJVKNUW6NLLHFDUKZ2SLBBGQWKOLJ3G2IRMEARGIZLTMMRDUIBCONUCQ53TNAUHG33SORSWI3LVNR2GSKCNFRNWENRYMFTDMZJUF42DQ2BPGBUC6MDIF4YWQXLYOB2WENSFJZMHKNTKKAZVQZ2YHFIUIS3ZGNSVGVKEOB2XG22CGNKWC2DHNFTEGNLKORKHURJZPJSWONDVNBGWU3KTO5SXANTSLJBGW2CUONKGOSRUOI3DIWKFOBSEWZBTGEYVSQSGKFXXGN2IGU2VG2LPGVVTSR2FM5JFQQTILFHFU5TNF4YC6KRMFYXC4KJJFERCYIBCL5YHKYRCHIQCEWLQOVRDM2ZWORGDCODKNVAW4TSSI5NHA2ZUOUZVOUCHIRWVOTLLMRNE43LYGNGXSU2ZMRIXS52DO5GU2SDRJZXUWSDFOFGECZ2VGZYEM33LJBFVCRTENE4DQ5SBK42GOM2UIVZUGQLZNVXXCNKMNZDFQZBVGRJGWUJY',
  'B$2J0705NUZUCRBZMY4DCSRCPUWCAITCNFYDIOC7GIRDUID3EJXGC3LFEI5CAITQGJ3XG2BCFQQCE6DGOARDUIBCHE2TGOJXIYZDSIRMEARGIZLSNF3CEORAEJWS6NBYNAXTA2BPGBUC6MTIEIWCAITYOB2WEIR2EARHQ4DVMI3EKTSYOU3GUUBTLBTVQQ2NM5JHCMKQMIYWETSYJNVFEWRXJJXE2OCSGE3VOODEJA3EOU3NJU2FM33LLFCXQUKYHBWXIU3XNZVHC6LYJI4HCTTEOJKDCVLTHBVE4532HBMTS3LWIJVW2TDIPJKHU52LJNMUK5C2IZGXG6SGKNRWEIRMEARGIZLTMMRDUIBCO5ZWQKDTN5ZHIZLENV2WY5DJFBGSYW3CGY4GCZRWMU2C6NBYNAXTA2BPGBUC6MTILV4HA5LCGZCU4WDVGZVFAM2YM5MEGTLHKJYTCUDCGFRE4WCLNJJFUN2KNZGTQURRG5LTQZCIGZDVG3KNGRLG622ZIV4FCWBYNV2FG53ONJYXS6CKHBYU4ZDSKQYVK4ZYNJHHO6RYLE4W25SCNNWUY2D2KR5HOS2LLFCXIWSGJVZXURSTMNRC6MBPFIWC4LROFEUSELBAEJPXA5LCEI5CAIS2OB2WENZUO44WIZTPMV2XES3SJNMEKM2TKBJHARTROVGFAVDLNFBXKU3X',
  'B$2J0706I52WQRD2IJTWERJUGJ3TKU3IIIZEM6CNNJWUU6LKLJYFGSRWK5UEY5BYPEYVAZKGJBIUKTCHM5YTER3NNN2HM2KGIREDQ6KGK5MVEV3HGR4FC2LXGN3DGMZVEJ6SYIBCMJUXANBVEI5CA6ZCNZQW2ZJCHIQCE4BSONUCELBAEJ4GM4BCHIQCEQRUGI4DEMJQHERCYIBCMRSXE2LWEI5CAITNF42DK2BCFQQCE6DQOVRCEORAEJ4HA5LCGY4UKS2QJZXTSSTLMQ3HMMTIG54E4S3XGVJGIYSGIJXWCSCFMNZXIWDDKJHGMY2RGJVGONZRNFDHA33CIN3WG6DGJJVGCVRSPFRUO6JSGE4GMMTKJUYXU3TROMYVGRDLOFGWSURXMZRHSQSWJJ3XUYLDM4ZFCYLSI52DCZ3UJJTSELBAEJSGK43DEI5CAITTNAUHG33SORSWI3LVNR2GSKCNFRNWENRYMFTDMZJUF42DK2C5PBYHKYRWHFCUWUCON44UU23EGZ3DE2BXPBHEW5ZVKJSGERSCN5QUQRLDON2FQY2SJZTGGUJSNJTTOMLJIZYG6YSDO5RXQZSKNJQVMMTZMNDXSMRRHBTDE2SNGF5G44LTGFJUI23RJVUVEN3GMJ4UEVSKO55GCY3HGJIWC4SHOQYWO5CKM4XTALZKFQXC4LRJFERH27I',
];

const psbtParts = [
  'B$ZP0200FMUE4KXZZ7EBBSWEYDAMBWEU7TK7DXEFYQ7P3PFGFMN2H3H7TVSFFZ3B6RIHF6CXOH6FYSPJ6YBAMEHY7P77676G7FVGANUDMTMUUEKJUG44DTYMM6XZPPF5EBZN6WVR3SPVYO56O2WADSP2GOZHI3ESMN7CCIOX2IAOILUNB33ASOV3QGJWOVT3XZAO6UXTEUHTE3T2VTZH7YWB3J3PD6B6YUNKMJ6ZWIM2NDYNPR7R7S4MRWPF76TSEVX4HPFVC4PYUG56BOHV2MRHMSE4BNVON5HUEGAYICDECMBDIMQ5RZN76WWN4LC2PFEVRJS2',
  'B$ZP02016XQ7HFWVE7WELUVVXO7D5HQ4DKNH3UJ52RWBCI6EXEGA2TAC5IIJMGEDRDKS7U47HGL2WF6VZA7AVGPWGQYHTASE3EY65FLMGBUVGXUJNH7Y5LQJ6CPK6XLZOPBZLFSF466JYQKSRSGPEBAMKFRGGNW36VNGT4P7ZAQMPONRPV5DFZ3CS7OJZTLGPT6X4U6MXLV3UETZ546SKMF4AIDQA',
];

const psbtPartsSingle = [
  'B$ZP0100FMUE4KXZZ7EBBSWEYDAMBWEU7TK7DXEFYQ7P3PFGFMN2H3H7TVSFFZ3B6RIHF6CXOH6FYSPJ6YBAMEHY7P77676G7FVGANUDMTMUUEKJUG44DTYMM6XZPPF5EBZN6WVR3SPVYO56O2WADSP2GOZHI3ESMN7CCIOX2IAOILUNB33ASOV3QGJWOVT3XZAO6UXTEUHTE3T2VTZH7YWB3J3PD6B6YUNKMJ6ZWIM2NDYNPR7R7S4MRWPF76TSEVX4HPFVC4PYUG56BOHV2MRHMSE4BNVON5HUEGAYICDECMBDIMQ5RZN76WWN4LC2PFEVRJS26XQ7HFWVE7WELUVVXO7D5HQ4DKNH3UJ52RWBCI6EXEGA2TAC5IIJMGEDRDKS7U47HGL2WF6VZA7AVGPWGQYHTASE3EY65FLMGBUVGXUJNH7Y5LQJ6CPK6XLZOPBZLFSF466JYQKSRSGPEBAMKFRGGNW36VNGT4P7ZAQMPONRPV5DFZ3CS7OJZTLGPT6X4U6MXLV3UETZ546SKMF4AIDQA',
];

const unsignedPsbtBase64 =
  'cHNidP8BAFUCAAAAAYJj9UHO0GGOL26C1LFaP/7JAicMAUgiQP54x850dbdwAAAAAAD9////AZ8mAAAAAAAAGXapFBkSnVPmMZuvGdugWb6tFm35Crj1iKwAAAAATwEEiLIeA+gYHoSAAAAApVtTTFLNsAkMmodvEI2lN6TgaNlIqk/kSAWG0ce+IXwC5GsdaDXjME37xmldW5916akNgJ6t0eEXMe5XXaScVKQQtor25FQAAIAAAACAAAAAgAABAHECAAAAAfsuOuyiqdITHHsl4eeEq8g/FGcrivXjk1VVa9FHVTaiAQAAAAAAAACAAhAnAAAAAAAAFgAUOvo1+WzTe6J8HeJUluVRY5AYdsYLqQYAAAAAABYAFDUNGJb+xaxQS58redmw1ISizkpDAAAAAAEBHxAnAAAAAAAAFgAUOvo1+WzTe6J8HeJUluVRY5AYdsYiBgM2uusio/9ZUkGdXY4uHM5dpNmbBjPX34JcrtctGG7vSRi2ivbkVAAAgAAAAIAAAACAAAAAAAAAAAAAAA==';

describe('bbqr tests', () => {
  it('can decode parts into valid wallet import', () => {
    const decoded = joinQRs(walletExportParts);
    assert.strictEqual(decoded.fileType, 'J');

    const parsed = JSON.parse(uint8ArrayToString(decoded.raw));
    assert.ok(parsed.xfp);
    assert.ok(parsed.xpub);
  });

  it('cant decode garbage/incomplete', () => {
    assert.throws(() => joinQRs(['B$2J0700PMRGG2']));
    assert.throws(() => joinQRs([]));
    assert.throws(() => joinQRs([walletExportParts[0]]));
    assert.throws(() => joinQRs([walletExportParts[6]]));

    assert.throws(() =>
      joinQRs([
        walletExportParts[0],
        walletExportParts[1],
        walletExportParts[2],
        walletExportParts[3],
        walletExportParts[4],
        walletExportParts[5],
      ]),
    );
  });

  it('can decode weird sequence', () => {
    joinQRs([
      walletExportParts[4],
      walletExportParts[5],
      walletExportParts[6],
      walletExportParts[0],
      walletExportParts[1],
      walletExportParts[2],
      walletExportParts[3],
    ]);
  });

  it('can decode psbt', () => {
    const decoded = joinQRs(psbtParts);
    assert.strictEqual(decoded.fileType, 'P');
    assert.strictEqual(uint8ArrayToString(decoded.raw).substring(0, 4), 'psbt');

    const psbtFromDecoded = bitcoin.Psbt.fromBase64(uint8ArrayToBase64(decoded.raw));
    assert.ok(psbtFromDecoded.data.inputs.length > 0);
    assert.ok(psbtFromDecoded.data.outputs.length > 0);
  });

  it('can decode psbt 2', () => {
    const decoded = joinQRs(psbtPartsSingle);
    assert.strictEqual(decoded.fileType, 'P');
    assert.strictEqual(uint8ArrayToString(decoded.raw).substring(0, 4), 'psbt');

    const psbtFromDecoded = bitcoin.Psbt.fromBase64(uint8ArrayToBase64(decoded.raw));
    assert.strictEqual(uint8ArrayToBase64(decoded.raw), unsignedPsbtBase64);
    assert.ok(psbtFromDecoded.data.inputs.length > 0);
    assert.ok(psbtFromDecoded.data.outputs.length > 0);
  });

  it('can encode data as bbqr parts', () => {
    const qrPayloads = splitQRs(base64ToUint8Array(unsignedPsbtBase64), 'P');
    assert.deepStrictEqual(qrPayloads.parts, [
      'B$ZP0100FMUE4KXZZ7EBBSWEYDAMBWEU7TK7DXEFYQ7P3PFGFMN2H3H7TVSFFZ3B6RIHF6CXOH6FYSPJ6YBAMEHY7P77676G7FVGANUDMTMUUEKJUG44DTYMM6XZPPF5EBZN6WVR3SPVYO56O2WADSP2GOZHI3ESMN7CCIOX2IAOILUNB33ASOV3QGJWOVT3XZAO6UXTEUHTE3T2VTZH7YWB3J3PD6B6YUNKMJ6ZWIM2NDYNPR7R7S4MRWPF76TSEVX4HPFVC4PYUG56BOHV2MRHMSE4BNVON5HUEGAYICDECMBDIMQ5RZN76WWN4LC2PFEVRJS26XQ7HFWVE7WELUVVXO7D5HQ4DKNH3UJ52RWBCI6EXEGA2TAC5IIJMGEDRDKS7U47HGL2WF6VZA7AVGPWGQYHTASE3EY65FLMGBUVGXUJNH7Y5LQJ6CPK6XLZOPBZLFSF466JYQKSRSGPEBAMKFRGGNW36VNGT4P7ZAQMPONRPV5DFZ3CS7OJZTLGPT6X4U6MXLV3UETZ546SKMF4AIDQA',
    ]);
  });
});

describe('BlueURDecoder', () => {
  it('can import wallet descriptor from coldcard q', async () => {
    const decoderPartial = new BlueURDecoder();
    decoderPartial.receivePart(walletExportParts[0]);
    assert.ok(!decoderPartial.isComplete());
    assert.ok(decoderPartial.estimatedPercentComplete() >= 1 / 7 && decoderPartial.estimatedPercentComplete() < 2 / 8);

    const decoder = new BlueURDecoder();
    for (const part of walletExportParts) {
      decoder.receivePart(part);
    }

    assert.ok(decoder.isComplete());

    const data = decoder.toString();

    // now, checking:

    const parsed = JSON.parse(data);
    assert.ok(parsed.xfp);
    assert.ok(parsed.xpub);
  });
});
